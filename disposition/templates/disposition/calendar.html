{% extends 'base.html' %}
{% load static %}

{% block content %}

    <link rel="stylesheet" href="{% static "css/fullcalendar.min.css" %}">
    <link href='{% static "css/scheduler.css" %}' rel='stylesheet' />
    <script type="text/javascript" src="{% static 'js/vendor/moment.js' %}"></script>

    <script type="text/javascript" src="{% static 'js/vendor/fullcalendar.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'js/vendor/locale-all.js' %}"></script>

    <script>
    $(function() {

      // page is now ready, initialize the calendar...
      $('#calendar').fullCalendar({
        // put your options and callbacks here
          locale: 'de',
          themeSystem: 'bootstrap3',
          weekNumbers: true,
          eventLimit: true,
          displayEventEnd: true,
          businessHours: {
              // days of week. an array of zero-based day of week integers (0=Sunday)
              dow: [ 1, 2, 3, 4, 5], // Monday - Thursday
              start: '10:00', // a start time (10am in this example)
              end: '18:00' // an end time (6pm in this example)
            },
          nowIndicator: true,
          header: {
            left: 'prev, next today',
            center: 'title',
            right: 'month, listMonth basicWeek listWeek, basicDay, listDay agendaWeek'
          },
eventRender: function(event, element, view) {
    var title = element.find('.fc-title, .fc-list-item-title');
    var start = moment(event.start).format("YYYY-MM-DD");
    var delivery_id = title.text();

    var html = "";

    if(view.type.includes("list")){
        {% for delivery in deliveries %}
            if('{{ delivery.delivery_id }}' == delivery_id) {
                html = "<p>" + '{{ delivery.delivery_id }}' + "</p>";
                title.html(html);
                element.find('.fc-list-item-time').empty()
            }
        {% endfor %}

        {% for truck in trucks %}
                if(title.text().includes("LKW{{ truck.pk }}")){
                    html += "LKW{{ truck.pk }}";
                    html += '&nbsp;&nbsp;<i class="fa fa-truck" style="color:orange;"></i>';
                    html += "<br/><br/>";

                    html += "<table class='table'><thead><tr>" +
                        "<th style='text-align:left;'>Transportdienstleister</th>" +
                        "<th style='text-align:left;'>Stückzahl</th>" +
                        "<th style='text-align:left;'>Mitarbeiter</th>" +
                        "</tr></thead><tbody>";
                    {% for truck in trucks %}
                        html += "<tr>" +
                            "<td>{{ truck.transport_service }}</td>" +
                            "<td>{{ truck.shipping_number_of_pieces }}</td>" +
                            "<td>" +
                            "{% for employee in truck.employees.all %}" +
                                "{% if employee.user.profile  %}" +
                                    "<img src='{{  employee.user.profile.profile_image.url }}' class='img-responsive img-circle' style='max-height:80px;'/>"
                                    +
                                    "{% endif %}" +
                                "{% endfor %}" +
                            "</td>" +
                            "</tr>";
                    {% endfor %}
                    html += "</tbody></table>";
                    title.html(html);
                }
        {% endfor %}
    }else{
        // keine Terminübersicht
        {% for delivery in deliveries %}
            if('{{ delivery.delivery_id }}' == delivery_id) {
                html = "{{ delivery.delivery_id }}";
                title.html(html);
                element.find('.fc-time').hide();
            }
        {% endfor %}

        {% for truck_appointment in truck_appointments %}
            if(title.text().includes("LKW{{ truck_appointment.truck.pk }}")){
                html = "LKW{{ truck_appointment.truck.pk }}";
                html += '&nbsp;&nbsp;<i class="fa fa-truck" style="color:yellow;"></i><br/>';
                html += "<div class='col-md-12' style='padding-left:0px;'>"
                html += "{% for employee in truck_appointment.employees.all %}" +
                        "<div class='col-md-2' style='padding-left:0px;'>" +
                        "<img class='img-responsive img-circle' src='{{ employee.user.profile.profile_image.url }}' style='max-height:100px;'/>" +
                        "</div>" +
                        "{% endfor %}";
                html += "</div>";
                title.html(html);
            }
        {% endfor %}
    }
},
            events: [
                {% for delivery in deliveries %}
                    {
                    {% if delivery.partial.mission.customer %}
                          title: '{{ delivery.delivery_id }}',
                    {% else %}
                          title: '{{  delivery.partial.mission.mission_number }}',
                    {% endif %}
                      start: '{{ delivery.delivery_date|date:"Y-m-d" }}T11:30:00',
                      end : '{{ delivery.delivery_date|date:"Y-m-d" }}T13:30:00',
                      allDay : false // will make the time show,
                    },
                {% endfor %}

                {% for truck_appointment in truck_appointments %}
                    {
                      title: 'LKW{{ truck_appointment.truck.pk }}',
                      start: '{{ truck_appointment.arrival_date |date:"Y-m-d" }}T{{ truck_appointment.arrival_time_start }}',
                      end : '{{ truck_appointment.arrival_date |date:"Y-m-d" }}T{{ truck_appointment.arrival_time_end }}',
                      allDay : false, // will make the time show,
                      color  : '#a12403',
                    },
                {% endfor %}
            // other events here
          ],
        eventColor: '#2aabd2'
      })

    });

    </script>

    <div class="panel panel-default">
        <div class="panel-body">
                <h3>Kalendaransicht</h3>
                <div id='calendar'></div>

        </div>
    </div>
{% endblock %}